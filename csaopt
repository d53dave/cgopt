#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import sys
import click
import asyncio
from app.utils import internet_connectivity_available, get_configs
from app.msgqclient.client import QueueClient
from app.model_loader.model_loader import ModelLoader


CONTEXT_SETTINGS = dict(help_option_names=['-h', '--help'])


def eprint(*args, **kwargs):
    print(*args, file=sys.stderr, **kwargs)


async def go(loop, model, ctx):
    client = await QueueClient.create(loop, ctx.obj['internal_conf'])
    asyncio.Task(periodic(client))
    await client._send_one('csaopt.data.in.t', value=model.to_dict())
    await client._consume()


async def periodic(client: QueueClient):
    while True:
        print('periodic')
        await asyncio.sleep(1)
        # await client._send_one('csaopt.data.in.t', key='TheKey', value={
        #     u'a': [(1, 2, 3), True]
        # })


@click.group()
@click.version_option(version='1.0.0')
@click.pass_context
def cli(ctx):
    try:
        internal_conf = get_configs('app/internal/csaopt-internal.conf')
        ctx.obj['internal_conf'] = internal_conf
        print('Configs loaded')
    except Exception as e:
        eprint('Could not load configs', e)
        sys.exit(1)


@cli.command(name='run',
             help='Run the optimization based on the provided config and model.')
@click.option('--model',
              default='user_model/',
              type=click.Path(exists=True, resolve_path=True),
              help='Folder containing the model that should be used for optimization.')
@click.option('--conf',
              default='conf/csaopt.conf',
              type=click.Path(exists=True, resolve_path=True),
              help='Path to the CSAOpt config. If not provided, \'conf/csaopt.conf\' will be used')
@click.pass_context
def run_opt(ctx, model, conf):
    print('Called run', ctx, model, conf)
    print('Has internet: ', internet_connectivity_available())

    loader = ModelLoader({
     'model_path': model
    }, ctx.obj['internal_conf'])
    model = loader.get_model()

    loop = asyncio.get_event_loop()
    loop.run_until_complete(go(loop, model, ctx))
    loop.close()


@cli.command(name='check',
             help='Check and validate the provided configuration and model.')
@click.option('--model',
              type=click.Path(exists=True, resolve_path=True),
              help='Folder containing the model that should be used for optimization.')
@click.option('--conf',
              default='conf/csaopt.conf',
              type=click.Path(exists=True, resolve_path=True),
              help='Path to the CSAOpt config. If not provided, \'conf/csaopt.conf\' will be used')
@click.option('--with-aws',
              is_flag=True,
              default=False,
              help='If enabled, the check will also spin up EC2 instances to verify configuration and communication.')
def run_check(**kwargs):
    print('Check called')


@cli.command(name='cleanup',
             help='Clean up generated files and terminate any running EC2 instances')
def cleanup():
    raise NotImplementedError


if __name__ == '__main__':
    print('Running CSAOpt')
    cli(obj={})
